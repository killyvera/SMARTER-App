// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  passwordHash      String
  name             String?
  phone            String?
  avatarUrl        String?
  biometricEnabled Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  goals              Goal[]
  biometricCredentials BiometricCredential[]
}

model Goal {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  status      String   @default("DRAFT")
  deadline    DateTime?
  plannedHours Float?   // Horas planificadas para goals de un solo día
  isSingleDayGoal Boolean @default(false) // Indica si es un goal de un solo día
  color       String?  // Color hexadecimal para identificación visual
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  smarterScore    SmarterScore?
  miniTasks       MiniTask[]
  readjustments   Readjustment[]
  suggestedTasks  SuggestedMiniTask[]

  @@index([userId])
  @@index([status])
}

model SmarterScore {
  id          String   @id @default(cuid())
  goalId      String   @unique
  specific    Float
  measurable  Float
  achievable  Float
  relevant    Float
  timebound   Float
  evaluate    Float
  readjust    Float
  average     Float
  passed      Boolean
  createdAt   DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)
}

model MiniTask {
  id           String   @id @default(cuid())
  goalId       String
  title        String
  description  String?
  status       String   @default("DRAFT")
  deadline     DateTime?
  unlocked     Boolean  @default(false)
  plannedHours Float?   // Horas planificadas para mini-tasks de un solo día
  isSingleDayTask Boolean @default(false) // Indica si es una task de un solo día
  metricsConfig String? // JSON string con configuración de plugins y métricas
  color        String?  // Color hexadecimal (heredado del goal o personalizado)
  positionX    Float?   // Posición X en el muro de notas (píxeles)
  positionY    Float?   // Posición Y en el muro de notas (píxeles)
  order        Int      @default(0) // Orden dentro del goal (0, 1, 2...)
  priority     String   @default("medium") // Prioridad: 'high', 'medium', 'low'
  dependsOn    String?  // ID de otra minitask que debe completarse primero (nullable)
  schedulingType String @default("sequential") // Tipo de scheduling: 'sequential', 'parallel', 'daily', 'scheduled'
  scheduledDate DateTime? // Fecha específica si es scheduled
  scheduledTime String?  // Hora específica HH:mm si es scheduled
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  goal         Goal            @relation(fields: [goalId], references: [id], onDelete: Cascade)
  score        MiniTaskScore?
  metrics      MiniTaskMetric[]
  plugins      MiniTaskPlugin[]
  journalEntries MiniTaskJournalEntry[]
  checklistItems MiniTaskChecklistItem[]

  @@index([goalId])
  @@index([status])
  @@index([unlocked])
  @@index([goalId, order])
  @@index([dependsOn])
  @@index([schedulingType])
}

model MiniTaskScore {
  id          String   @id @default(cuid())
  miniTaskId  String   @unique
  specific    Float
  measurable  Float
  achievable  Float
  relevant    Float
  timebound   Float
  average     Float
  passed      Boolean
  createdAt   DateTime @default(now())

  miniTask MiniTask @relation(fields: [miniTaskId], references: [id], onDelete: Cascade)
}


model Readjustment {
  id              String   @id @default(cuid())
  goalId          String
  previousSnapshot String  // JSON string del estado anterior del goal
  newSnapshot     String   // JSON string del nuevo estado del goal
  reason          String?
  createdAt       DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
}

model SuggestedMiniTask {
  id          String   @id @default(cuid())
  goalId      String
  title       String
  description String?
  priority    Int      @default(0)
  createdAt   DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
}

model MiniTaskMetric {
  id          String   @id @default(cuid())
  miniTaskId  String
  pluginId    String   // ID del plugin que generó esta métrica
  metricType  String   // Tipo de métrica (e.g., "progress", "completion", "time")
  value       String   // Valor de la métrica (JSON string para flexibilidad)
  metadata    String?  // Metadata adicional (JSON string)
  recordedAt  DateTime @default(now())

  miniTask MiniTask @relation(fields: [miniTaskId], references: [id], onDelete: Cascade)

  @@index([miniTaskId])
  @@index([pluginId])
  @@index([recordedAt])
}

model MiniTaskPlugin {
  id          String   @id @default(cuid())
  miniTaskId  String
  pluginId    String   // ID del plugin (e.g., "calendar", "reminder", "progress-tracker")
  config      String   // Configuración del plugin (JSON string)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  miniTask MiniTask @relation(fields: [miniTaskId], references: [id], onDelete: Cascade)

  @@unique([miniTaskId, pluginId])
  @@index([miniTaskId])
  @@index([pluginId])
}

model MiniTaskJournalEntry {
  id              String   @id @default(cuid())
  miniTaskId      String
  entryDate       DateTime // Fecha de la entrada (una entrada por día)
  progressValue   Float?   // Valor numérico de progreso
  progressUnit    String?  // Unidad: horas, páginas, items, porcentaje, etc.
  notes           String?  // Notas libres del usuario
  obstacles       String?  // Obstáculos encontrados
  mood            String?  // Estado de ánimo: positivo, neutral, negativo
  timeSpent       Int?     // Minutos dedicados
  checklistCompleted Boolean? // Si el checklist del día fue completado
  metricsData     String?  // JSON con datos específicos de métricas configuradas
  coachQuery      String?  // Pregunta al agente coach
  coachResponse   String?  // Respuesta del agente coach
  coachSuggestions String? // JSON con sugerencias del agente
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  miniTask MiniTask @relation(fields: [miniTaskId], references: [id], onDelete: Cascade)

  @@unique([miniTaskId, entryDate])
  @@index([miniTaskId])
  @@index([entryDate])
}

model MiniTaskChecklistItem {
  id          String   @id @default(cuid())
  miniTaskId  String
  label       String   // Texto del elemento (ej: "Lienzo", "Pinturas", "Pinceles")
  completed   Boolean  @default(false)
  completedAt DateTime?
  order       Int      @default(0) // Orden en la lista
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  miniTask MiniTask @relation(fields: [miniTaskId], references: [id], onDelete: Cascade)

  @@index([miniTaskId])
  @@index([completed])
}

model BiometricCredential {
  id               String   @id @default(cuid())
  userId           String
  credentialId     String   @unique // ID de la credencial WebAuthn (base64url)
  publicKey        String   // Clave pública en formato JSON
  counter          Int      @default(0) // Contador de uso para prevenir replay attacks
  deviceName       String?  // Nombre del dispositivo (ej: "Mi iPhone", "Laptop Windows")
  authenticatorType String? // Tipo: "platform" (huella/face del dispositivo), "cross-platform" (passkey), etc.
  enabled          Boolean  @default(true) // Si está activo o desactivado
  createdAt        DateTime @default(now())
  lastUsedAt       DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialId])
  @@index([userId, enabled])
}

