// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  goals Goal[]
}

model Goal {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  status      String   @default("DRAFT")
  deadline    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  smarterScore    SmarterScore?
  miniTasks       MiniTask[]
  checkIns        CheckIn[]
  readjustments   Readjustment[]
  suggestedTasks  SuggestedMiniTask[]

  @@index([userId])
  @@index([status])
}

model SmarterScore {
  id          String   @id @default(cuid())
  goalId      String   @unique
  specific    Float
  measurable  Float
  achievable  Float
  relevant    Float
  timebound   Float
  evaluate    Float
  readjust    Float
  average     Float
  passed      Boolean
  createdAt   DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)
}

model MiniTask {
  id          String   @id @default(cuid())
  goalId      String
  title       String
  description String?
  status      String   @default("DRAFT")
  deadline    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  goal  Goal            @relation(fields: [goalId], references: [id], onDelete: Cascade)
  score MiniTaskScore?

  @@index([goalId])
  @@index([status])
}

model MiniTaskScore {
  id          String   @id @default(cuid())
  miniTaskId  String   @unique
  specific    Float
  measurable  Float
  achievable  Float
  relevant    Float
  timebound   Float
  average     Float
  passed      Boolean
  createdAt   DateTime @default(now())

  miniTask MiniTask @relation(fields: [miniTaskId], references: [id], onDelete: Cascade)
}

model CheckIn {
  id                String   @id @default(cuid())
  goalId            String
  progressPercentage Float
  currentValue      String?
  notes             String?
  mood              String?
  createdAt         DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@index([createdAt])
}

model Readjustment {
  id              String   @id @default(cuid())
  goalId          String
  previousSnapshot String  // JSON string del estado anterior del goal
  newSnapshot     String   // JSON string del nuevo estado del goal
  reason          String?
  createdAt       DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
}

model SuggestedMiniTask {
  id          String   @id @default(cuid())
  goalId      String
  title       String
  description String?
  priority    Int      @default(0)
  createdAt   DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
}

